#Monica Sanchez. 01/02/21
#Run all commands in the output folder. Input file should be there.

interactive -m 20
conda activate mutcall


#######SAREK 2.6############

#### Bam alignment

#Bam files and haplotype caller for normal sample
nextflow run /workspace/users/msanchezg/bin/sarek-2.6.1/main.nf -profile singularity -c /workspace/users/msanchezg/bin/sarek-2.6.1/sarek.conf --input input.tsv --tools HaplotypeCaller --genome GRCh38 --igenomes_base /workspace/datasets/genomes/iGenomes/

#Bam files for tumor sample (added increase of memory usage to speed up)
nextflow run /workspace/users/msanchezg/bin/sarek-2.6.1/main.nf -profile singularity -c /workspace/users/msanchezg/bin/sarek-2.6.1/sarek_2.conf --markdup_java_options '"-Xms4000m -Xmx150g"' --input input_t.tsv --genome GRCh38 --igenomes_base /workspace/datasets/genomes/iGenomes/

#Bam files for tumor sample, with flag --no_gatk_spark to avoid the exceeded time on MarkDuplicates (Oriol's e-mail)
nextflow run /workspace/users/msanchezg/bin/sarek-2.6.1/main.nf -profile singularity -c /workspace/users/msanchezg/bin/sarek-2.6.1/sarek_2.conf --markdup_java_options '"-Xms4000m -Xmx150g"' --input input_t.tsv --genome GRCh38 --igenomes_base /workspace/datasets/genomes/iGenomes/ --no_gatk_spark

### Variant Calling

#Variant calling of mutect, strelka, ASCAT and Manta, using sarek version from dev branch (had some bugs the version I downloaded (2.6.1), sarek's people told me to use that version)
nextflow run nf-core/sarek -r dev -profile singularity -c /workspace/users/msanchezg/bin/sarek-2.6.1/sarek.conf --input input_vc.tsv --step variant_calling --tools 'Strelka,ASCAT,Manta,mutect2'




########SAREK 2.7##########

#### Bam alignment

#Bam files for tumor sample, with version 2.7. When using version 2.6 with --no_gatk_spark flag, it breaks due to exceeded job memory. It looks like the 2.7 version does not have these bugs.
nextflow run nf-core/sarek -r 2.7 -profile singularity -c /workspace/users/msanchezg/bin/sarek-2.6.1/sarek_2.conf --markdup_java_options '"-Xms4000m -Xmx150g"' --input input_t.tsv

### Variant Calling

#Variant calling of mutect, strelka, ASCAT and Manta, using sarek version from dev branch (had some bugs the version I downloaded (2.6.1), sarek's people told me to use that version)
nextflow run nf-core/sarek -r dev -profile singularity -c /workspace/users/msanchezg/bin/sarek-2.6.1/sarek.conf --input input_vc.tsv --step variant_calling --tools 'Strelka,ASCAT,Manta,mutect2'

#Variant calling of mutect, strelka, ASCAT and Manta, using sarek version -r 2.6.1 (current dev branch (v2.7) there is a bug, 02022021), and using same reference genome as HMF pipeline (GCA_000001405.15_GRCh38_no_alt_analysis_set.fna)
nextflow run nf-core/sarek -r 2.7 -profile singularity -c /workspace/users/msanchezg/bin/sarek-2.6.1/sarek.conf --input input_vc.tsv --step variant_calling --tools 'Strelka,ASCAT,Manta,mutect2' --fasta /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fa --fasta_fai /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fa.fai --dict /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.dict --germline_resource /workspace/datasets/genomes/iGenomes/Homo_sapiens/GATK/GRCh38/Annotation/GermlineResource/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz --germline_resource_index /workspace/datasets/genomes/iGenomes/Homo_sapiens/GATK/GRCh38/Annotation/GermlineResource/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz.tbi

#Variant calling of mutect, strelka, ASCAT and Manta, using sarek version -r 2.7 (the last one, looks like the bug has been fixed?), and indicating local files for gnomAD reference file, because Mutect2 was giving an error on parsing the foreign files from GATK repository (java.io.IOException: Invalid file pointer: 219075122888942 for /workspace/nobackup/sjd_seq/sarek_results/pt7/AW8048_vs_AW8053/work/89/a020c162444ba5f55c862f72df3cfe/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz)
nextflow run nf-core/sarek -r 2.7 -profile singularity -c /workspace/users/msanchezg/bin/sarek-2.6.1/sarek.conf --input input_vc.tsv --step variant_calling --tools 'Strelka,ASCAT,Manta,mutect2' --germline_resource /workspace/datasets/genomes/iGenomes/Homo_sapiens/GATK/GRCh38/Annotation/GermlineResource/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz --germline_resource_index /workspace/datasets/genomes/iGenomes/Homo_sapiens/GATK/GRCh38/Annotation/GermlineResource/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz.tbi




######SAREK v.3.0.1###### (15/09/2022)

#Cram alignment and haplotype caller for normal samples. Using the reference genome with no_ALT (the one used in Hartwig)
nextflow run nf-core/sarek -r 3.0.1 -profile singularity -c /workspace/datasets/sjd_seq/code/sarek/sarek_3.0.1.conf --input input_fastq_tissues.csv --genome GATK.GRCh38 --tools haplotypecaller --fasta /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fa --fasta_fai /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fa.fai --dict /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.dict --bwa False --save_reference

#Variant calling of haplotype caller. Using no_ALT ref file (same as Hartwig pipeline)
nextflow run nf-core/sarek -r 3.0.1 -profile singularity -c /workspace/datasets/sjd_seq/code/sarek/sarek_3.0.1.conf --input input_haplo.csv --step variant_calling --tools 'haplotypecaller' --fasta /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fa --fasta_fai /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fa.fai --dict /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.dict --germline_resource /workspace/datasets/genomes/iGenomes/Homo_sapiens/GATK/GRCh38/Annotation/GermlineResource/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz --germline_resource_tbi /workspace/datasets/genomes/iGenomes/Homo_sapiens/GATK/GRCh38/Annotation/GermlineResource/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz.tbi

#Variant calling of mutect (tumor only). Using no_ALT ref file (same as Hartwig pipeline)
nextflow run nf-core/sarek -r 3.0.1 -profile singularity -c /workspace/datasets/sjd_seq/code/sarek/sarek_3.0.1.conf --input input_mutect.csv --step variant_calling --tools 'mutect2' --fasta /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fa --fasta_fai /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fa.fai --dict /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.dict --germline_resource /workspace/datasets/genomes/iGenomes/Homo_sapiens/GATK/GRCh38/Annotation/GermlineResource/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz --germline_resource_tbi /workspace/datasets/genomes/iGenomes/Homo_sapiens/GATK/GRCh38/Annotation/GermlineResource/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz.tbi

#Variant calling of mutect (tumor vs normal) (added naming of normal sample in the config file because there is a bug). Using no_ALT ref file (same as Hartwig pipeline) !!MUTECT IN THIS VERSION IS NOT PERFORMING THE LAST STEP FILTERINGS!!!
nextflow run nf-core/sarek -r 3.0.1 -profile singularity -c /workspace/datasets/sjd_seq/code/sarek/sarek_3.0.1.conf --input input_vc.csv --step variant_calling --tools 'strelka,ascat,manta,mutect2' --fasta /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fa --fasta_fai /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fa.fai --dict /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.dict --germline_resource /workspace/datasets/genomes/iGenomes/Homo_sapiens/GATK/GRCh38/Annotation/GermlineResource/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz --germline_resource_tbi /workspace/datasets/genomes/iGenomes/Homo_sapiens/GATK/GRCh38/Annotation/GermlineResource/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz.tbi


########## SAREK 3.1.1 ######################## 09/12/22

#bam alignment and haplotype caller for normal samples. Using the reference genome with no_ALT (the one used in Hartwig)
nextflow run nf-core/sarek -r 3.1.1 -profile singularity -c /workspace/datasets/sjd_seq/code/sarek/sarek_3.1.conf --input input_fastq_new_tissues_LOPEBIG50.csv --genome GATK.GRCh38 --tools haplotypecaller --fasta /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fa --fasta_fai /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fa.fai --dict /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.dict --bwa False --save_reference --save_output_as_bam


#variant calling mutect (tumor vs normal) ref genome same as HMF (no ALT contigs). Fixed mutect last step filterings.
nextflow run nf-core/sarek -r 3.1.1 -profile singularity -c /workspace/users/msanchezg/bin/sarek-2.6.1/sarek.conf --input input_vc.csv --step variant_calling --tools mutect2 --fasta /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fa --fasta_fai /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fa.fai --dict /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.dict --germline_resource /workspace/datasets/genomes/iGenomes/Homo_sapiens/GATK/GRCh38/Annotation/GermlineResource/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz --germline_resource_tbi /workspace/datasets/genomes/iGenomes/Homo_sapiens/GATK/GRCh38/Annotation/GermlineResource/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz.tbi

#variant calling mutect (tumor only) ref genome same as HMF (no ALT contigs). Fixed mutect last step filterings.
nextflow run nf-core/sarek -r 3.1.1 -profile singularity -c /workspace/users/msanchezg/bin/sarek-2.6.1/sarek.conf --input input_mutect_LOPEBIG51.csv --step variant_calling --tools mutect2 --fasta /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fa --fasta_fai /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fa.fai --dict /workspace/datasets/genomes/GRCh38/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.dict --germline_resource /workspace/datasets/genomes/iGenomes/Homo_sapiens/GATK/GRCh38/Annotation/GermlineResource/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz --germline_resource_tbi /workspace/datasets/genomes/iGenomes/Homo_sapiens/GATK/GRCh38/Annotation/GermlineResource/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz.tbi
